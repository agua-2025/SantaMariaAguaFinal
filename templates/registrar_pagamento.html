<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrar Pagamento - Águas de Santa Maria</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Estilo refinado para um visual compacto e profissional, alinhado com o sistema */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f4f7f9;
        color: #343a40;
        font-size: 0.9rem;
      }
      .container {
        background-color: #ffffff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
        margin-top: 20px;
        margin-bottom: 20px;
        max-width: 900px;
      }
      h3 {
        color: #0056b3;
        font-weight: 600;
        font-size: 1.5rem;
        margin-bottom: 2rem;
        text-align: center;
      }
      .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #007bff;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #007bff;
      }
      .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.3rem;
        font-size: 0.85rem;
      }
      .form-control,
      .form-select {
        border-radius: 6px;
        font-size: 0.9rem;
        padding: 0.55rem 0.75rem;
      }
      .form-control[readonly] {
        background-color: #e9ecef;
        cursor: not-allowed;
      }
      .info-display-box {
        background-color: #e9ecef;
        border-radius: 6px;
        padding: 0.55rem 0.75rem;
        font-size: 0.9rem;
        color: #212529;
        font-weight: 500;
        min-height: calc(1.5em + 1.1rem + 2px);
        display: flex;
        align-items: center;
      }
      .saldo-message {
        font-weight: 600;
        margin-top: 1rem;
        font-size: 1rem;
        text-align: center;
        padding: 0.75rem;
        border-radius: 6px;
        background-color: #f8f9fa;
      }
      .total-box {
        background-color: #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        text-align: center;
      }
      .total-box .form-label {
        font-weight: 600;
        color: #0056b3;
      }
      .total-box .display-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #212529;
      }
      .text-success {
        color: #198754 !important;
      }
      .text-danger {
        color: #dc3545 !important;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container">
      <h3 class="mb-4">
        <i class="bi bi-cash-coin me-2"></i>Registrar Pagamento
      </h3>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="mb-3">
        {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <form method="POST" id="pagamentoForm">
        <h5 class="section-title">Seleção da Fatura</h5>
        <div class="row mb-3">
          <div class="col-md-6 mb-3 mb-md-0">
            <label for="consumidorSelect" class="form-label"
              >Consumidor *</label
            >
            <select
              class="form-select"
              id="consumidorSelect"
              name="consumidor_id"
              required
            >
              <option value="" disabled selected>
                Selecione um consumidor
              </option>
              {% for consumidor in consumidores %}
              <option value="{{ consumidor.id }}">{{ consumidor.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="leituraSelect" class="form-label"
              >Fatura Pendente *</label
            >
            <select
              class="form-select"
              id="leituraSelect"
              name="leitura_id"
              required
            >
              <option value="">Aguardando seleção do consumidor</option>
            </select>
          </div>
        </div>

        <hr class="my-4" />

        <div class="row">
          <!-- Coluna da Esquerda: Dados e Entradas -->
          <div class="col-lg-7">
            <h5 class="section-title">Cálculo de Valores</h5>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Vencimento Original</label>
                <div class="info-display-box" id="dataVencimentoDisplay">
                  DD/MM/AAAA
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Saldo Devedor Anterior</label>
                <div class="info-display-box" id="saldoPendenteOriginalDisplay">
                  R$ 0,00
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Multa</label>
                <div class="info-display-box" id="valorMulta">R$ 0,00</div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Juros</label>
                <div class="info-display-box" id="valorJuros">R$ 0,00</div>
              </div>
            </div>

            <h5 class="section-title mt-3">Registro do Pagamento</h5>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="data_pagamento" class="form-label"
                  >Data do Pagamento *</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="data_pagamento"
                  name="data_pagamento"
                  required
                  readonly
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="forma_pagamento" class="form-label"
                  >Forma de Pagamento *</label
                >
                <select
                  class="form-select"
                  id="forma_pagamento"
                  name="forma_pagamento"
                  required
                >
                  <option value="PIX">PIX</option>
                  <option value="Transferencia">Transferência</option>
                  <option value="Boleto">Boleto</option>
                  <option value="Dinheiro">Dinheiro</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Coluna da Direita: Totais e Valor Pago -->
          <div class="col-lg-5">
            <h5 class="section-title">Valores Finais</h5>
            <div class="mb-3">
              <div class="total-box">
                <label class="form-label">TOTAL A PAGAR HOJE</label>
                <div class="display-value" id="totalCorrigido">R$ 0,00</div>
              </div>
            </div>
            <div class="mb-3">
              <label for="valorPago" class="form-label"
                >Valor Efetivamente Pago *</label
              >
              <input
                type="text"
                class="form-control form-control-lg"
                id="valorPago"
                name="valor_pago"
                required
                placeholder="R$ 0,00"
              />
            </div>
            <div class="saldo-message" id="saldoMessage">
              Aguardando preenchimento...
            </div>
          </div>
        </div>

        <input type="hidden" id="saldoCredor" name="saldo_credor" />
        <input type="hidden" id="saldoDevedor" name="saldo_devedor" />

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
          <button
            type="button"
            class="btn btn-primary px-4"
            data-bs-toggle="modal"
            data-bs-target="#confirmacaoModal"
          >
            <i class="bi bi-check-circle-fill me-2"></i>Registrar Pagamento
          </button>
          <a href="{{ url_for('dashboard') }}" class="btn btn-secondary px-4"
            >Cancelar</a
          >
        </div>
      </form>
    </div>

    <!-- Modal de Confirmação -->
    <div
      class="modal fade"
      id="confirmacaoModal"
      tabindex="-1"
      aria-labelledby="confirmacaoModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmacaoModalLabel">
              Confirmar Pagamento
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            Você confirma o registro deste pagamento?
            <div class="mt-3 p-3 bg-light rounded">
              <strong>Valor a ser registrado:</strong>
              <span
                id="valorConfirmacao"
                class="fw-bold fs-5 text-success"
              ></span>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="confirmarPagamentoBtn"
            >
              Sim, confirmar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function formatar(valor) {
        const numero = parseFloat(valor);
        if (isNaN(numero)) return "R$ 0,00";
        return "R$ " + numero.toFixed(2).replace(".", ",");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const consumidorSelect = document.getElementById("consumidorSelect");
        const leituraSelect = document.getElementById("leituraSelect");
        const valorMultaDisplay = document.getElementById("valorMulta");
        const valorJurosDisplay = document.getElementById("valorJuros");
        const totalCorrigidoDisplay = document.getElementById("totalCorrigido");
        const dataPagamentoInput = document.getElementById("data_pagamento");
        const valorPagoInput = document.getElementById("valorPago");
        const saldoCredorInput = document.getElementById("saldoCredor");
        const saldoDevedorInput = document.getElementById("saldoDevedor");
        const saldoMessage = document.getElementById("saldoMessage");
        const saldoPendenteOriginalDisplay = document.getElementById(
          "saldoPendenteOriginalDisplay"
        );
        const dataVencimentoDisplay = document.getElementById(
          "dataVencimentoDisplay"
        );

        // --- CORREÇÃO DE FUSO HORÁRIO APLICADA AQUI ---
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0"); // Mês de 1-12
        const day = String(today.getDate()).padStart(2, "0");
        dataPagamentoInput.value = `${year}-${month}-${day}`;
        // ---------------------------------------------

        consumidorSelect.addEventListener("change", function () {
          fetchLecturesForConsumer(this.value);
        });

        function fetchLecturesForConsumer(consumidorId) {
          leituraSelect.innerHTML = '<option value="">Carregando...</option>';
          fetchLeituraDetails(null);
          if (!consumidorId) {
            leituraSelect.innerHTML =
              '<option value="">Selecione um consumidor</option>';
            return;
          }
          const dataPagamentoRef = dataPagamentoInput.value;
          fetch(
            `/api/leituras/${consumidorId}?data_pagamento_ref=${dataPagamentoRef}`
          )
            .then((res) =>
              res.ok ? res.json() : Promise.reject(new Error("Falha na rede"))
            )
            .then((data) => {
              if (data.length === 0) {
                leituraSelect.innerHTML =
                  '<option value="">Nenhuma fatura pendente</option>';
                return;
              }
              leituraSelect.innerHTML =
                '<option value="" disabled selected>Selecione uma fatura</option>';
              data.forEach((leitura) => {
                const option = document.createElement("option");
                option.value = leitura.id;
                const dataFatura = new Date(
                  leitura.data_leitura_atual + "T00:00:00"
                );
                const mesFatura = String(dataFatura.getMonth() + 1).padStart(
                  2,
                  "0"
                );
                const anoFatura = dataFatura.getFullYear();
                const periodoTexto = `Ref. ${mesFatura}/${anoFatura}`;
                option.textContent = `Fatura ${periodoTexto} | Saldo: ${formatar(
                  leitura.valor_corrigido_total_para_proximo_pagamento
                )}`;
                leituraSelect.appendChild(option);
              });
            })
            .catch((error) => {
              console.error("Erro ao buscar leituras:", error);
              leituraSelect.innerHTML =
                '<option value="">Erro ao carregar leituras</option>';
            });
        }

        function fetchLeituraDetails(leituraId) {
          saldoPendenteOriginalDisplay.textContent = "R$ 0,00";
          dataVencimentoDisplay.textContent = "DD/MM/AAAA";
          valorMultaDisplay.textContent = "R$ 0,00";
          valorJurosDisplay.textContent = "R$ 0,00";
          totalCorrigidoDisplay.textContent = "R$ 0,00";
          valorPagoInput.value = "";
          saldoMessage.innerHTML = "Aguardando preenchimento...";
          saldoCredorInput.value = "";
          saldoDevedorInput.value = "";

          if (!leituraId) return;

          const dataPagamentoParaAPI = dataPagamentoInput.value;
          fetch(
            `/get-leitura-details/${leituraId}?data_pagamento_ref=${dataPagamentoParaAPI}`
          )
            .then((res) =>
              res.ok ? res.json() : Promise.reject(new Error("Falha na rede"))
            )
            .then((details) => {
              saldoPendenteOriginalDisplay.textContent = formatar(
                details.valor_base_para_novas_penalidades
              );
              dataVencimentoDisplay.textContent = new Date(
                details.data_vencimento + "T00:00:00"
              ).toLocaleDateString("pt-BR", { timeZone: "UTC" });
              valorMultaDisplay.textContent = formatar(details.multa);
              valorJurosDisplay.textContent = formatar(details.juros);
              totalCorrigidoDisplay.textContent = formatar(
                details.total_corrigido
              );
              valorPagoInput.value = formatar(details.total_corrigido);
              valorPagoInput.dispatchEvent(new Event("input"));
            })
            .catch((error) => console.error("Erro ao buscar detalhes:", error));
        }

        leituraSelect.addEventListener("change", function () {
          fetchLeituraDetails(this.value);
        });

        valorPagoInput.addEventListener("input", function () {
          let value = this.value.replace(/\D/g, "");
          this.value = formatar(value / 100);
          const pagoLimpo = parseFloat(value / 100) || 0;
          const totalCorrigidoLimpo =
            parseFloat(
              totalCorrigidoDisplay.textContent
                .replace("R$", "")
                .replace(/\./g, "")
                .replace(",", ".")
            ) || 0;
          const diferenca = pagoLimpo - totalCorrigidoLimpo;
          saldoDevedorInput.value = "";
          saldoCredorInput.value = "";
          if (diferenca < -0.001) {
            saldoMessage.innerHTML = `<span class='text-danger'>Saldo Devedor: ${formatar(
              Math.abs(diferenca)
            )}</span>`;
            saldoDevedorInput.value = Math.abs(diferenca).toFixed(2);
          } else if (diferenca > 0.001) {
            saldoMessage.innerHTML = `<span class='text-success'>Saldo Credor: ${formatar(
              diferenca
            )}</span>`;
            saldoCredorInput.value = diferenca.toFixed(2);
          } else {
            saldoMessage.innerHTML = `<span class='text-muted'>Dívida quitada!</span>`;
          }
        });

        const pagamentoForm = document.getElementById("pagamentoForm");
        const valorConfirmacaoSpan =
          document.getElementById("valorConfirmacao");
        const confirmarPagamentoBtn = document.getElementById(
          "confirmarPagamentoBtn"
        );

        document
          .querySelector('[data-bs-target="#confirmacaoModal"]')
          .addEventListener("click", function () {
            if (pagamentoForm.checkValidity()) {
              const valorPago = valorPagoInput.value || "R$ 0,00";
              valorConfirmacaoSpan.textContent = valorPago;
              // Apenas mostra o modal, não o cria repetidamente
              const modal = bootstrap.Modal.getOrCreateInstance(
                document.getElementById("confirmacaoModal")
              );
              modal.show();
            } else {
              pagamentoForm.reportValidity();
            }
          });

        confirmarPagamentoBtn.addEventListener("click", function () {
          pagamentoForm.submit();
        });
      });
    </script>
  </body>
</html>
